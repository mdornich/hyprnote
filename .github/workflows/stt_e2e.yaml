on:
  workflow_dispatch:
    inputs:
      provider:
        type: choice
        options:
          - deepgram
          - assemblyai
          - soniox
          - gladia
          - fireworks
          - openai
          - elevenlabs
  push:
    branches:
      - main
    paths:
      - crates/transcribe-proxy/**
      - crates/owhisper-client/src/adapter/**
  pull_request:
    paths:
      - crates/transcribe-proxy/**
      - crates/owhisper-client/src/adapter/**

jobs:
  detect-changes:
    if: github.event_name != 'workflow_dispatch'
    runs-on: ubuntu-latest
    outputs:
      provider: ${{ steps.detect.outputs.provider }}
    steps:
      - uses: actions/checkout@v4
      - uses: dorny/paths-filter@v3
        id: filter
        with:
          filters: |
            deepgram:
              - 'crates/owhisper-client/src/adapter/deepgram/**'
            assemblyai:
              - 'crates/owhisper-client/src/adapter/assemblyai/**'
            soniox:
              - 'crates/owhisper-client/src/adapter/soniox/**'
            gladia:
              - 'crates/owhisper-client/src/adapter/gladia/**'
            fireworks:
              - 'crates/owhisper-client/src/adapter/fireworks/**'
            openai:
              - 'crates/owhisper-client/src/adapter/openai/**'
            elevenlabs:
              - 'crates/owhisper-client/src/adapter/elevenlabs/**'
      - id: detect
        run: |
          if [ "${{ steps.filter.outputs.deepgram }}" == "true" ]; then echo "provider=deepgram" >> $GITHUB_OUTPUT
          elif [ "${{ steps.filter.outputs.assemblyai }}" == "true" ]; then echo "provider=assemblyai" >> $GITHUB_OUTPUT
          elif [ "${{ steps.filter.outputs.soniox }}" == "true" ]; then echo "provider=soniox" >> $GITHUB_OUTPUT
          elif [ "${{ steps.filter.outputs.gladia }}" == "true" ]; then echo "provider=gladia" >> $GITHUB_OUTPUT
          elif [ "${{ steps.filter.outputs.fireworks }}" == "true" ]; then echo "provider=fireworks" >> $GITHUB_OUTPUT
          elif [ "${{ steps.filter.outputs.openai }}" == "true" ]; then echo "provider=openai" >> $GITHUB_OUTPUT
          elif [ "${{ steps.filter.outputs.elevenlabs }}" == "true" ]; then echo "provider=elevenlabs" >> $GITHUB_OUTPUT
          else echo "provider=deepgram" >> $GITHUB_OUTPUT
          fi

  setup:
    runs-on: ubuntu-latest
    needs: [detect-changes]
    if: always()
    outputs:
      provider: ${{ steps.set.outputs.provider }}
    steps:
      - id: set
        run: |
          if [ "${{ github.event_name }}" == "workflow_dispatch" ]; then
            echo "provider=${{ inputs.provider }}" >> $GITHUB_OUTPUT
          else
            echo "provider=${{ needs.detect-changes.outputs.provider }}" >> $GITHUB_OUTPUT
          fi

  proxy-live:
    needs: setup
    if: needs.setup.outputs.provider != ''
    runs-on: depot-ubuntu-24.04-8
    steps:
      - uses: actions/checkout@v4
      - uses: ./.github/actions/rust_install
        with:
          platform: linux
      - uses: ./.github/actions/infisical_install
      - run: infisical run --token="$INFISICAL_TOKEN" --env=dev --projectId="$INFISICAL_PROJECT_ID" --path="/stt" -- cargo test -p transcribe-proxy proxy_e2e::${{ needs.setup.outputs.provider }}::live -- --ignored --nocapture
        env:
          INFISICAL_TOKEN: ${{ secrets.INFISICAL_TOKEN }}
          INFISICAL_PROJECT_ID: ${{ secrets.INFISICAL_PROJECT_ID }}

  proxy-batch:
    needs: setup
    if: needs.setup.outputs.provider != ''
    runs-on: depot-ubuntu-24.04-8
    steps:
      - uses: actions/checkout@v4
      - uses: ./.github/actions/rust_install
        with:
          platform: linux
      - uses: ./.github/actions/infisical_install
      - run: infisical run --token="$INFISICAL_TOKEN" --env=dev --projectId="$INFISICAL_PROJECT_ID" --path="/stt" -- cargo test -p transcribe-proxy proxy_e2e::${{ needs.setup.outputs.provider }}_batch::batch -- --ignored --nocapture
        env:
          INFISICAL_TOKEN: ${{ secrets.INFISICAL_TOKEN }}
          INFISICAL_PROJECT_ID: ${{ secrets.INFISICAL_PROJECT_ID }}

  adapter-live:
    needs: setup
    if: needs.setup.outputs.provider != ''
    runs-on: depot-ubuntu-24.04-8
    steps:
      - uses: actions/checkout@v4
      - uses: ./.github/actions/rust_install
        with:
          platform: linux
      - uses: ./.github/actions/infisical_install
      - run: infisical run --token="$INFISICAL_TOKEN" --env=dev --projectId="$INFISICAL_PROJECT_ID" --path="/stt" -- cargo test -p owhisper-client adapter::${{ needs.setup.outputs.provider }}::live -- --ignored --nocapture --test-threads=1
        env:
          INFISICAL_TOKEN: ${{ secrets.INFISICAL_TOKEN }}
          INFISICAL_PROJECT_ID: ${{ secrets.INFISICAL_PROJECT_ID }}

  adapter-batch:
    needs: setup
    if: needs.setup.outputs.provider != ''
    runs-on: depot-ubuntu-24.04-8
    steps:
      - uses: actions/checkout@v4
      - uses: ./.github/actions/rust_install
        with:
          platform: linux
      - uses: ./.github/actions/infisical_install
      - run: infisical run --token="$INFISICAL_TOKEN" --env=dev --projectId="$INFISICAL_PROJECT_ID" --path="/stt" -- cargo test -p owhisper-client adapter::${{ needs.setup.outputs.provider }}::batch -- --ignored --nocapture
        env:
          INFISICAL_TOKEN: ${{ secrets.INFISICAL_TOKEN }}
          INFISICAL_PROJECT_ID: ${{ secrets.INFISICAL_PROJECT_ID }}
