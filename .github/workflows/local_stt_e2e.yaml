on:
  workflow_dispatch:
  push:
    branches: [main]
    paths:
      - crates/transcribe-cactus/**
      - crates/cactus/**
      - crates/cactus-sys/**
  pull_request:
    paths:
      - crates/transcribe-cactus/**
      - crates/cactus/**
      - crates/cactus-sys/**

jobs:
  local-stt-e2e:
    runs-on: depot-ubuntu-24.04-arm-8
    strategy:
      matrix:
        model:
          - name: whisper-small
            repo: openai/whisper-small
    defaults:
      run:
        shell: bash
    steps:
      - uses: actions/checkout@v4
      - run: git clone --depth 1 --branch v1.7 https://github.com/cactus-compute/cactus.git cactus
      - uses: ./.github/actions/rust_install
        with:
          platform: linux
      - run: |
          sudo apt-get update
          sudo apt-get install -y cmake build-essential libcurl4-openssl-dev libclang-dev
      - run: |
          pip3 install --break-system-packages huggingface-hub
          pip3 install --break-system-packages -e cactus/python/ --no-deps
      - uses: actions/cache@v4
        with:
          path: cactus/weights/
          key: cactus-models-${{ matrix.model.name }}-arm-v1
      - run: cactus download ${{ matrix.model.repo }}
      - run: cargo test -p transcribe-cactus -- --ignored --nocapture
        env:
          CACTUS_STT_MODEL: ${{ github.workspace }}/cactus/weights/${{ matrix.model.name }}
          CACTUS_CLOUD_API_KEY: ${{ secrets.CACTUS_CLOUD_API_KEY }}
          E2E_AUDIO_SECS: 20
