# https://github.com/tauri-apps/tauri-action/blob/3013cac/examples/test-build-only.yml
on:
  workflow_dispatch:
  push:
    branches:
      - main
    paths:
      - apps/desktop/**
      - plugins/**
      - crates/**
      - Cargo.toml
      - Cargo.lock
  pull_request:
    paths:
      - apps/desktop/**
      - plugins/**
      - crates/**
      - Cargo.toml
      - Cargo.lock
jobs:
  desktop_ci:
    defaults:
      run:
        shell: bash
    strategy:
      fail-fast: false
      matrix:
        include:
          - platform: "macos"
            runner: "depot-macos-14"
          - platform: "linux"
            runner: "depot-ubuntu-22.04-8"
          - platform: "windows"
            runner: "windows-latest"
    runs-on: ${{ matrix.runner }}
    steps:
      - uses: actions/checkout@v4
      - uses: ./.github/actions/pnpm_install
      - uses: denoland/setup-deno@v2
      - run: pnpm -F ui build
      - run: pnpm -F desktop typecheck
      - run: pnpm -F desktop test
      - uses: ./.github/actions/install_desktop_deps
        with:
          target: ${{ matrix.platform }}
      - uses: ./.github/actions/rust_install
        with:
          platform: ${{ matrix.platform }}
      - run: cargo check -p desktop
      - run: cargo test -p desktop
        if: matrix.platform != 'windows'
      - run: cargo test -p desktop --no-run
        if: matrix.platform == 'windows'
      - name: Test workspace crates
        run: |
          EXTRA_EXCLUDES=""
          if [[ "${{ matrix.platform }}" == "windows" ]]; then
            EXTRA_EXCLUDES="--exclude gbnf --exclude tauri-plugin-dock --exclude tauri-plugin-flag --exclude tauri-plugin-git --exclude tauri-plugin-mcp"
          fi
          cargo test --workspace \
            $EXTRA_EXCLUDES \
            --exclude desktop \
            --exclude control-tauri \
            --exclude ai \
            --exclude email \
            --exclude lago \
            --exclude mac \
            --exclude notch \
            --exclude notification-macos \
            --exclude tcc \
            --exclude apple-note \
            --exclude notification-linux \
            --exclude am \
            --exclude am2 \
            --exclude aec \
            --exclude agc \
            --exclude whisper \
            --exclude whisper-local \
            --exclude whisper-local-model \
            --exclude moonshine \
            --exclude kyutai \
            --exclude vad2 \
            --exclude vad3 \
            --exclude vvad \
            --exclude vad-ext \
            --exclude onnx \
            --exclude pyannote-local \
            --exclude llama \
            --exclude granola-cli \
            --exclude eval-cli \
            --exclude tools \
            --exclude docs \
            --exclude bundle \
            --exclude host \
            --exclude intercept \
            --exclude extensions-runtime \
            --exclude frontmatter \
            --exclude openstatus \
            --exclude audio \
            --exclude audio-device \
            --exclude transcribe-whisper-local \
            --exclude device-monitor \
            --exclude tauri-plugin-analytics\
            --exclude tauri-plugin-apple-calendar \
            --exclude tauri-plugin-apple-contact \
            --exclude tauri-plugin-audio-priority \
            --exclude tauri-plugin-auth \
            --exclude tauri-plugin-bedrock \
            --exclude tauri-plugin-db2 \
            --exclude tauri-plugin-deeplink2 \
            --exclude tauri-plugin-detect \
            --exclude tauri-plugin-extensions \
            --exclude tauri-plugin-fs-db \
            --exclude tauri-plugin-fs-sync \
            --exclude tauri-plugin-fs2 \
            --exclude tauri-plugin-hooks \
            --exclude tauri-plugin-icon \
            --exclude tauri-plugin-importer \
            --exclude tauri-plugin-js \
            --exclude tauri-plugin-listener \
            --exclude tauri-plugin-listener2 \
            --exclude tauri-plugin-local-llm \
            --exclude tauri-plugin-local-stt \
            --exclude tauri-plugin-misc \
            --exclude tauri-plugin-network \
            --exclude tauri-plugin-notification \
            --exclude tauri-plugin-notify \
            --exclude tauri-plugin-opener2 \
            --exclude tauri-plugin-overlay \
            --exclude tauri-plugin-path2 \
            --exclude tauri-plugin-pdf \
            --exclude tauri-plugin-permissions \
            --exclude tauri-plugin-screen \
            --exclude tauri-plugin-settings \
            --exclude tauri-plugin-sfx \
            --exclude tauri-plugin-sidecar2 \
            --exclude tauri-plugin-store2 \
            --exclude tauri-plugin-tantivy \
            --exclude tauri-plugin-template \
            --exclude tauri-plugin-tracing \
            --exclude tauri-plugin-tray \
            --exclude tauri-plugin-updater2 \
            --exclude tauri-plugin-webhook \
            --exclude tauri-plugin-windows

  ci:
    if: always()
    needs: [desktop_ci]
    runs-on: ubuntu-latest
    steps:
      - run: exit 1
        if: contains(needs.*.result, 'failure') || contains(needs.*.result, 'cancelled')
